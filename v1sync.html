<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <title>SlickGrid example 3: Editing</title>
  <link rel="stylesheet" href="js/SlickGrid-master/slick.grid.css" type="text/css"/>
  <link rel="stylesheet" href="js/SlickGrid-master/css/smoothness/jquery-ui-1.8.16.custom.css" type="text/css"/>
  <link rel="stylesheet" href="js/SlickGrid-master/examples.css" type="text/css"/>
  <style>
    .cell-title {
      font-weight: bold;
    }

    .cell-effort-driven {
      text-align: center;
    }
    
      .changed {
      background: orange;
    }
    
    
    .sync {
      background: #FFE6E6;
    }
    
    
    .highlight {
      background: #F9F9B4;
	}
	
	
	.slick-headerrow-column {
      background: #87ceeb;
      text-overflow: clip;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }

    .slick-headerrow-column input {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }


    
    
  </style>
</head>
<body>
<div style="position:relative">
  <div style="width:3000px;">
     <b>v1 epics | corporateInterest==true</b>
    <br>
    <div id="v1Grid" style="width:100%;height:800px;"></div>
    
    <!--
    <b>onKanban initiatives</b>
    <br>
    <div id="itemGrid" style="width:100%;height:300px;"></div>

    <b>targets</b>
    <br>
    <div id="targetGrid" style="width:100%;height:500px;"></div>
   --> 

  </div>


 </div>

<script src="js/d3.v3.min.js"></script>
<script src="js/SlickGrid-master/lib/jquery-1.7.min.js"></script>
<script src="js/SlickGrid-master/lib/jquery-ui-1.8.16.custom.min.js"></script>
<script src="js/SlickGrid-master/lib/jquery.event.drag-2.2.js"></script>

<script src="js/SlickGrid-master/slick.core.js"></script>
<script src="js/SlickGrid-master/slick.dataview.js"></script>

<script src="js/SlickGrid-master/plugins/slick.cellrangedecorator.js"></script>
<script src="js/SlickGrid-master/plugins/slick.cellrangeselector.js"></script>
<script src="js/SlickGrid-master/plugins/slick.cellselectionmodel.js"></script>
<script src="js/SlickGrid-master/slick.formatters.js"></script>
<script src="js/SlickGrid-master/slick.editors.js"></script>
<script src="js/SlickGrid-master/slick.grid.js"></script>

<script>
  function requiredFieldValidator(value) {
    if (value == null || value == undefined || !value.length) {
      return {valid: false, msg: "This is a required field"};
    } else {
      return {valid: true, msg: null};
    }
  }

var initiativeData;
var targetData;
var epicData;

// compare epic with initiative data 
var comparedData;

	$.when($.getJSON("/data/data.php?type=initiatives"),
				$.getJSON("/data/data.php?type=targets"),
				$.getJSON("http://knbnprxy.ea.bwinparty.corp/rest/epics"))
				//$.getJSON("/data/epics.json"))
				
			.done(function(initiatives,targets,epics){
					if (initiatives[1]=="success") initiativeData=initiatives[0];
					else throw new Exception("error loading initiatives");
					if (targets[1]=="success") targetData=targets[0];
					else throw new Exception("error loading targets");
					if (epics[1]=="success") {
						epicData=epics[0];
					}
					
					else throw new Exception("error loading epics");
					
					cleanupEpicData();
					compareData  = compareData(initiativeData,epicData);
					
					//epicData = filterByNameValue(epicData,"CategoryName","FeatureGroup");
					compareData = filterByNameValue(compareData,"CategoryName","Initiative");
					
					renderV1EpicGrid();
					//renderInitiativeGrid();
					//renderTargetGrid();
					
					
				});

				
  var grid;
  
  var columnFilters={};

/*
var url = "http://v1.bwinparty.corp/V1-Production/rest-1.v1/Data/Epic/3387482";
var headers = { Authorization: "Basic " + btoa("s.a.V1-Strategy:baw1234"), Accept: "haljson" };
var settings = { url: url, headers: headers, dataType: "json" };
$.ajax(settings).done(function(data) {
    beautifulJson = JSON.stringify(data, null, 4);
    $("body").html("<pre>" + beautifulJson + "</pre>");
}).fail(function(jqXHR) {
    $("body").html(jqXHR.responseText);
});	
*/


// ======================== helper & comapre stuff ========================

function cleanupEpicData(){
	for (var i in epicData){
			epicData[i].ID = epicData[i].ID.split("Epic:")[1]; 
	}
	
}

function compareData(initiatives,epics){
	
	var _compare = new Array();
	
	for (var e in epics){
			var _initiative = lookupByField(initiatives,"ExtId",epics[e].ID);
			if (_initiative){
				// ok we have already an initiative in kanban system for this epic 
				// so lets mark it 
				epics[e]["isOnKanban"]=true;
				epics[e]["kanbanName"]=_initiative.name;
				epics[e]["kanbanSwag"]=_initiative.Swag;
				epics[e]["kanbanActualDate"]=_initiative.actualDate;
				epics[e]["kanbanLane"]=_initiative.lane;
				epics[e]["kanbanSubLane"]=_initiative.sublane;
				epics[e]["kanbanHealth"]=_initiative.health;
				epics[e]["kanbanId"]=_initiative.id;
				epics[e]["kanbanState"]=_initiative.state;
				
			}
			else epics[e]["isOnKanban"]=false;
			
			
			
			_compare.push(epics[e]);
	}
	return _compare;
}

function filterByNameValue(list,name,value){
	var _filtererdList = new Array();
	for (var l in list){
		if (list[l][name]==value) _filtererdList.push(list[l]);
	}
	return _filtererdList;
}


function lookupByField(list,field,value){
	for (var i in list){
		//console.log("** checking: "+list[i][field]+" == "+value);
		if (list[i][field]==value) {
			//console.log ("==== MATCH !");
			return list[i];
		}
	}

}

// ======================== helper & comapre stuff ========================




function renderV1EpicGrid(){


var columns = [

        { id:"sync", name: "sync", field: "sync",width:40,formatter: Slick.Formatters.Checkmark, editor: Slick.Editors.Checkbox ,sortable:true, sorter:NumericSorter,cssClass:"sync"},
        
        { id:"id", name: "v1.id", field: "ID",sortable:true,width:70,formatter:Slick.Formatters.V1EpicURL, sorter:NumericSorter ,toolTip:"V1 internal OID"},
        { id:"number", name: "v1.number", field: "Number",sortable:true, sorter:NumericSorter},
        { id:"kanbanId", name: "kanban.id", field: "kanbanId",sortable:true, sorter:NumericSorter},
        
        { id:"isOnKanban", name: "isOnKanban", field: "isOnKanban",formatter: Slick.Formatters.Checkmark, editor: Slick.Editors.Checkbox ,sortable:true, sorter:NumericSorter},
        
        { id: "name", name: "v1.name", field: "Name", editor: Slick.Editors.Text ,width:400, cssClass: "cell-title",sortable:true, sorter:NumericSorter},
        { id: "kanbanName", name: "kanban.name", field: "kanbanName",width:200 },
        { id:"changeDate", name: "v1.changeDate", field: "ChangeDateUTC",formatter: Slick.Formatters.SimpleDate,sortable:true,width:80,sorter:NumericSorter },
        { id:"createDate", name: "v1.createDate", field: "CreateDateUTC",formatter: Slick.Formatters.SimpleDate,sortable:true,width:80 },{ id: "healthComment", name: "health comment", field: "HealthComment", editor: Slick.Editors.Text ,width:500, cssClass: "cell-title"},
        { id: "kanbanLane", name: "kanban.lane", field: "kanbanLane",sortable:true, sorter:NumericSorter,width:80 },
        { id: "kanbanSubLane", name: "kanban.sublane", field: "kanbanSubLane",width:80 },
        { id:"status", name: "v1.status", field: "Status",sortable:true },
        { id: "kanbanState", name: "kanban.state", field: "kanbanState",width:80 },
        { id:"swag", name: "v1.swag", field: "Swag",sortable:true, sorter:NumericSorter },
        { id:"kanbanSwag", name: "kanban.Swag", field: "kanbanSwag",sortable:true, sorter:NumericSorter },
        { id:"categoryName", name: "v1.categoryName", field: "CategoryName",sortable:true ,sorter:NumericSorter},
        { id:"health", name: "v1.health", field: "Health",formatter: Slick.Formatters.RAG,sortable:true },
		{ id:"kanbanHealth", name: "kanban.health", field: "kanbanHealth",formatter: Slick.Formatters.RAG,sortable:true },
		{ id:"scope", name: "v1.backlog", field: "Scope",sortable:true },
		{ id:"createdBy", name: "v1.createdBy", field: "CreatedBy",sortable:true },
      
        { id:"plannedStart", name: "v1.plannedStart", field: "PlannedStart",formatter: Slick.Formatters.SimpleDate,sortable:true,width:80 },
        { id:"plannedEnd", name: "v1.plannedEnd", field: "PlannedEnd",formatter: Slick.Formatters.SimpleDate,sortable:true,width:80 },
        { id:"launchDate", name: "v1.launchDate", field: "LaunchDate",formatter: Slick.Formatters.SimpleDate,sortable:true,width:80 },
        { id:"kanbanActualDate", name: "kanban.actualDate", field: "kanbanActualDate",sortable:true,width:80},
        //{ id:"estimatedDone", name: "estimatedDone", field: "EstimatedDone",sortable:true,width:150 },
          
        { id: "description", name: "v1.description", field: "Description", editor: Slick.Editors.Text ,width:500, cssClass: "cell-title"},
        { id: "patentprotection", name: "v1.patentprotection", field: "Patentprotection", editor: Slick.Editors.Text ,width:500, cssClass: "cell-title"}
        


  ];

  var options = {
    editable: true,
    //enableAddRow: true,
    enableCellNavigation: true,
    asyncEditorLoading: false,
    cellHighlightCssClass: "changed",
    cellHighlightCssClass: "changed",
    autoEdit: true,
    showHeaderRow:true,
    explicitInitialization:true,
	/*
	dataItemColumnValueExtractor: function(item, columnDef) {
		if(columnDef.editor == Slick.Editors.SelectOption){
			return eval(columnDef.options)[item[columnDef.field]];
		}else{
			return item[columnDef.field];
		}    
	}*/
}
	

    
   /* https://github.com/mleibman/SlickGrid/blob/gh-pages/examples/example-checkbox-row-select.html
   	var checkboxSelector = new Slick.CheckboxSelectColumn({
      cssClass: "slick-cell-checkboxsel"
    });
    columns.push(checkboxSelector.getColumnDefinition());
*/
    
    
	var dataView = new Slick.Data.DataView();
	dataView.setItems(compareData,"ID");

 
    v1grid = new Slick.Grid("#v1Grid", dataView, columns, options);
    
    //v1grid.setSelectionModel(new Slick.CellSelectionModel());
	//v1grid.setSelectionModel(new Slick.RowSelectionModel({selectActiveRow: true}));
	


    v1grid.onAddNewRow.subscribe(function (e, args) {
      var item = args.item;
      targetgrid.invalidateRow(data.length);
      data.push(item);
      v1grid.updateRowCount();
      v1grid.render();
    });


    
    v1grid.onSort.subscribe(function (e, args) {
		//console.log("**** sorting..by: "+args.sortCol.field);
		 var comparer = function(a, b) {
			return (a[args.sortCol.field] > b[args.sortCol.field]) ? 1 : -1;
		}

		  // Delegate the sorting to DataView.
		  // This will fire the change events and update the grid.
		  dataView.sort(comparer, args.sortAsc);
	});
	
    
    dataView.onRowsChanged.subscribe(function(e,args) {
		v1grid.invalidateRows(args.rows);
		v1grid.render();
	});
	
	
	v1grid.onCellChange.subscribe(function(e,args){
		console.log("***** CellChanged: "+args);
		
	});
	
	// ----------------------- column filter --------------------------------
	$(v1grid.getHeaderRow()).delegate(":input", "change keyup", function (e) {
      console.log("~~~~ keyup");
      
      var columnId = $(this).data("columnId");
       console.log("* columnId: "+columnId);
      if (columnId != null) {
        columnFilters[columnId] = $.trim($(this).val());
        dataView.refresh();
      }
    });

	
	v1grid.onHeaderRowCellRendered.subscribe(function(e, args) {
        $(args.node).empty();
        $("<input type='text'>")
           .data("columnId", args.column.id)
           .val(columnFilters[args.column.id])
           .appendTo(args.node);
    });

	
	v1grid.init();

    //dataView.beginUpdate();
    //dataView.setItems(compareData,"ID");
    dataView.setFilter(filter);
    //dataView.endUpdate();

	// ------------------------  column filter ----------------------------------
      
	
}

/**
* for column filter prototype
*/
function filter(item) {
    //console.log("##### filter called:");
    for (var columnId in columnFilters) {
      if (columnId !== undefined && columnFilters[columnId] !== "") {
        var c = v1grid.getColumns()[v1grid.getColumnIndex(columnId)];
        //console.log("**** filter triggered: c="+item[c.field]);
        if (item[c.field] != columnFilters[columnId]) {
          return false;
        }
      }
    }
    return true;
  }


function renderInitiativeGrid(){


var columns = [

        { id:"id", name: "id", field: "id",sortable:true },
        { id:"ExtId", name: "ExtId", field: "ExtId",sortable:true },
        { id: "name", name: "name", field: "name", editor: Slick.Editors.Text ,width:200, cssClass: "cell-title"},
        { id: "name2", name: "name2",  field: "name2",width:150 },
        { id: "Swag", name: "Swag", field: "Swag",width:50,editor:Slick.Editors.Integer },
		{ id: "planDate", name: "planDate", field: "planDate", editor: Slick.Editors.Date,sortable:true },
		{ id: "actualDate", name: "actualDate", field: "actualDate", editor: Slick.Editors.Date,sortable:true },
	    { id: "state", name: "state",  field: "state" },
        { id: "health", name: "health",  field: "health" },
		{ id: "DoD", name: "DoD", field: "DoD", editor: Slick.Editors.LongText},
        { id: "isCorporate", name: "isCorporate", field: "isCorporate",formatter: Slick.Formatters.Checkmark, editor: Slick.Editors.Checkbox},
        { id: "bm", name: "businessmodel",  field: "bm" },
        { id: "theme", name: "theme",  field: "theme" },
        { id: "lane", name: "lane",  field: "lane" },
        { id: "sublane", name: "sublane",  field: "sublane" },
        { id: "productOwner", name: "productOwner",  field: "productOwner",width:150 },
        { id: "type", name: "type",  field: "Type",editor: Slick.Editors.SelectOption,options: { 1: 'item', 2: 'innovation', 3: 'target' } }

  ];

  var options = {
    editable: true,
    enableAddRow: true,
    enableCellNavigation: true,
    asyncEditorLoading: false,
    cellHighlightCssClass: "changed",
    autoEdit: true,
	dataItemColumnValueExtractor: function(item, columnDef) {
		if(columnDef.editor == Slick.Editors.SelectOption){
			return eval(columnDef.options)[item[columnDef.field]];
		}else{
			return item[columnDef.field];
		}    
	}
}
    itemgrid = new Slick.Grid("#itemGrid", initiativeData, columns, options);
    
     itemgrid.setSelectionModel(new Slick.CellSelectionModel());

    itemgrid.onAddNewRow.subscribe(function (e, args) {
      var item = args.item;
      itemgrid.invalidateRow(data.length);
      data.push(item);
      itemgrid.updateRowCount();
      itemgrid.render();
    });
}


function renderTargetGrid(){


var columns = [

        { id:"id", name: "id", field: "id",sortable:true },
        { id:"ranking", name: "ranking", field: "ranking",sortable:true },
        { id: "name", name: "name", field: "name", editor: Slick.Editors.Text ,width:200, cssClass: "cell-title"},
        { id: "name2", name: "name2",  field: "name2",width:150 },
        { id: "Swag", name: "Swag", field: "Swag",width:50,editor:Slick.Editors.Integer },
		{ id: "targetDate", name: "targetDate", field: "targetDate", editor: Slick.Editors.Date,sortable:true },
		{ id: "description", name: "description", field: "description", editor: Slick.Editors.LongText },
	    { id: "scope", name: "scope", field: "scope", editor: Slick.Editors.LongText },
	    { id: "nonscope", name: "nonscope", field: "nonscope", editor: Slick.Editors.LongText },
	    { id: "metrics", name: "metrics", field: "metrics", editor: Slick.Editors.LongText },
	    { id: "risk", name: "risk", field: "risk", editor: Slick.Editors.LongText },
	    { id: "status", name: "status",  field: "status" },
        { id: "targetOwner", name: "targetOwner",  field: "targetOwner",width:150 },
        { id: "syndicate", name: "syndicate",  field: "syndicate",width:150 },
	    { id: "commercialScope", name: "commercialScope", field: "commercialScope", editor: Slick.Editors.LongText },
	    { id: "remark", name: "remark", field: "remark", editor: Slick.Editors.LongText },
	    { id: "initiatives", name: "initiatives", field: "initiatives"},
        { id: "bm", name: "businessmodel",  field: "bm" },
        { id: "theme", name: "theme",  field: "theme" },
        { id: "lane", name: "lane",  field: "lane" },
        { id: "sublane", name: "sublane",  field: "sublane" }


  ];

  var options = {
    editable: true,
    enableAddRow: true,
    enableCellNavigation: true,
    asyncEditorLoading: false,
    cellHighlightCssClass: "changed",
    autoEdit: true,
	dataItemColumnValueExtractor: function(item, columnDef) {
		if(columnDef.editor == Slick.Editors.SelectOption){
			return eval(columnDef.options)[item[columnDef.field]];
		}else{
			return item[columnDef.field];
		}    
	}
}


 
    targetgrid = new Slick.Grid("#targetGrid", targetData, columns, options);
    
     targetgrid.setSelectionModel(new Slick.CellSelectionModel());

    targetgrid.onAddNewRow.subscribe(function (e, args) {
      var item = args.item;
      targetgrid.invalidateRow(data.length);
      data.push(item);
      targetgrid.updateRowCount();
      targetgrid.render();
    });
}



// Define some sorting functions
function NumericSorter(a, b) {
  var x = a[sortcol], y = b[sortcol];
  return sortdir * (x == y ? 0 : (x > y ? 1 : -1));
}




 </script>
</body>
</html>
