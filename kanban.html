<!DOCTYPE html> 
<meta charset="utf-8">
<head>


<link rel="stylesheet" type="text/css" href="css/kanban.css">
<link rel="stylesheet" type="text/css" href="css/kanban_b2c.css">


<script src="js/d3.v3.min.js"></script>
<script src="js/date.min.js"></script>
<script src="js/jquery-2.0.3.min.js"></script>
<script src="bootstrap/dist/js/bootstrap.min.js"></script>

<script src="js/vkbeautify.0.99.00.beta.js"></script>

<script src="js/underscore-min.js"></script>
<script src="js/underscore.nest.min.js"></script>



<script src="js/kanban.js"></script>

<link rel="stylesheet" type="text/css" href="bootstrap/dist/css/bootstrap.min.css">

<!--
<link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,300italic,700' rel='stylesheet' type='text/css'>
-->

</head>

<!-- ---------------------------------------------- KANBAN  ------------------------------------------------------------->
<script>
	
	TRANSCODE_URL = "http://tomcat.ea.bwinparty.corp/transcode/";
	//TRANSCODE_URL = "http://localhost:8080/transcode";
	
	
	WIDTH=1500;
	HEIGHT = 1100;

	ITEM_SCALE=0.8;
	ITEMDATA_NEST= ["theme","lane","sublane"];
	//ITEMDATA_NEST= ["bm","theme","lane","themesl","sublane"];
	//ITEMDATA_NEST = ["bm","theme","lane","sublane"];

	
	ITEMDATA_FILTER = {"name":"bm", "operator":"==", "value":"b2c gaming"};
	CONTEXT=ITEMDATA_FILTER.value;


	//percentages is for override => if not specified it uses mode to auto layout
	itemDataConfig = [	
						{"level":"bm", "mode": "auto","percentages":
								[
									{"context":"holding","name":"b2c gaming","value"	:80},
									{"context":"holding","name":"new biz","value"		:20}
									
								]
						},
						{"level":"theme", "mode": "auto","percentages":
								[
									{"context":"b2c gaming", "name":"topline","value"	:60},
									{"context":"b2c gaming","name":"enabling","value"	:40},
									{"context":"holding", "name":"b2c gaming.topline","value"	:65},
									{"context":"holding","name":"b2c gaming.enabling","value"	:35},
									{"context":"new biz","name":"topline","value"		:100},
									{"context":"new biz","name":"enabling","value"		:0}
									
								]
						},
						{"level":"lane","mode": "auto","percentages":
								
								[
									{"context":"*","name":"topline.bwin","value"		:28},
									{"context":"*","name":"topline.pp","value"		:20},
									{"context":"*","name":"topline.foxy","value"		:18},
									{"context":"*","name":"topline.premium","value"	:14},
									{"context":"*","name":"topline.casino","value"	:20},
									{"context":"*","name":"enabling.techdebt","value"	:40},
									{"context":"*","name":"enabling.shared","value"	:60},
									{"context":"*","name":"topline.kalixa","value"	:50},
									{"context":"*","name":"topline.wincom","value"	:35},
									{"context":"*","name":"topline.conspo","value"	:15}

								]
									
						},
						// selective override only for one sublane works too ;-)
						{"level":"sublane","mode":"equal","percentages":
								[
									{"context":"*","name":"bwin.touch","value"	:20},
									{"context":"*","name":"bwin.click","value"	:20},
									{"context":"*","name":"bwin.market","value"	:20},
									{"context":"*","name":"bwin.product","value"	:20},
									{"context":"*","name":"bwin.enabling","value":20}
								]
						},
						
						// selective override only for one sublane works too ;-)
						{"level":"themesl","mode":"equal","percentages":
								[
									{"context":"bwin.drill-in","name":"Markets","value"	:25},
									{"context":"bwin.drill-in","name":"Product","value"	:25},
									{"context":"bwin.drill-in","name":"Customer","value"	:15},
									{"context":"bwin.drill-in","name":"Enabling","value"	:10},
									{"context":"bwin.drill-in","name":"Supplier","value"	:10},
									{"context":"bwin.drill-in","name":"Poker","value"	:5},
									{"context":"bwin.drill-in","name":"Casino/Games","value"	:5},
									{"context":"bwin.drill-in","name":"Cross - selling","value":5}
								]
						},
						
						{"level":"sublane","mode":"equal","percentages":
								[
									{"context":"bwin.drill-in","name":"regulated","value"	:60},
									{"context":"bwin.drill-in","name":"com","value"	:40}
								]
						}
						
						
						];		


	METRICDATES_DATA=[
					{"dimension": "baseline", "data": {"date":new Date("2013-12-31"),"title":"BASELINE 2013" ,"sub":"results for"}},
					{"dimension": "forecast1", "data": {"date":new Date("2013-12-31"),"title":"FORECAST 2014" ,"sub":"best-case for"}},
					{"dimension": "forecast2", "data": {"date":new Date("2013-12-31"),"title":"FORECAST 2015" ,"sub":"best-case for"}},
					{"dimension": "goal", "data": {"date":new Date("2013-12-31"),"title":"GOAL" ,"sub":"norbert says"}}
		];

	render("external.svg","lanetext","initiatives","metrics","releases","postits");
	//render("initiatives_v20.csv","metrics.csv","releases.txt","external.svg","lanes.csv");
	//render("initiatives_v19.csv","metrics.csv","releases.txt","external.svg","lanes.csv");
	
	
</script>

<!-- ---------------------------------------------- BODY ------------------------------------------------------------->

<body>

<!-- Hidden <FORM> to submit the SVG data to the server, which will convert it to SVG/PDF/PNG downloadable file.
     The form is populated and submitted by the JavaScript below. -->
     
<!-- production transcoder (tomcat6): http://www.kathan.at/transcode/--> 
<!-- dev transcoder(jetty on ubuntu): http://localhost:8080/transcode/--> 
<!--<form id="svgform" method="post" action="http://tomcat.ea.bwinparty.corp/transcode/">-->

<form id="svgform" method="post" action="localhost:8080/transcode/">

 <input type="hidden" id="format" name="format" value="">
 <input type="hidden" id="data" name="data" value="">
 <input type="hidden" id="context" name="context" value="">
 <input type="hidden" id="svg_width" name="svg_width" value="">
 <input type="hidden" id="svg_height" name="svg_height" value="">
 <input type="hidden" id="png_scale" name="png_scale" value="">
 
</form>

<pre class="prettyprint lang-xml" style="font-size:8px" id="svg_code">
</pre>
<script>


/*
   Utility function: populates the <FORM> with the SVG data
   and the requested output format, and submits the form.
*/
function submit_download_form(output_format)
{
	//dirty hack for the CSS declaration
	// last css is for bootstrap => exclude !
	
	var declaration ="";
	for (var i=0;i<(document.styleSheets.length-1);i++){
		console.log("***"+i);
		declaration = declaration+"<?xml-stylesheet href=\""+document.styleSheets[i].href+"\" type=\"text/css\"?>";
	}
	console.log("***declaration"+declaration);

	// Get the d3js SVG element
	var svg = document.getElementsByTagName("svg")[0];
	// Extract the data as SVG text string
	var svg_xml = (new XMLSerializer).serializeToString(svg);
	var form = document.getElementById("svgform");
	
	//console.log(declaration+svg_xml);
	form.action=TRANSCODE_URL;
	form["format"].value = output_format;
	form["data"].value = declaration+svg_xml ;
	form["context"].value = CONTEXT ;
	form["svg_width"].value = WIDTH ;
	form["svg_height"].value = HEIGHT ;
	//high res scale
	form["png_scale"].value = 3 ;
	console.log("*going to submit");
	
	form.submit();
}

function show_svg_code()
{
	console.log("*****show_svg_code");
	
	// Get the d3js SVG element
	var svg = document.getElementsByTagName("svg")[0];

	// Extract the data as SVG text string
	var svg_xml = (new XMLSerializer).serializeToString(svg);

	//Optional: prettify the XML with proper indentations
	svg_xml = vkbeautify.xml(svg_xml);
	// Set the content of the <pre> element with the XML
	$("#svg_code").text(svg_xml);

}

</script>



<div style="margin-left:10px;margin-top:10px">

	<div class="btn-group-xs">
	  <button id="b70" type="button" class="btn btn-success">Holding</button>
	  <button id="b71" type="button" class="btn btn-success">B2C Gaming</button>
	  <button id="b72" type="button" class="btn btn-success">New Biz</button>
	  <button id="b73" type="button" class="btn btn-success">Bwin</button>
	  <button id="b77" type="button" class="btn btn-success">Techdebt</button>
	  <button id="b78" type="button" class="btn btn-success">Shared</button>
	  <button id="b74" type="button" class="btn btn-danger">Bwin Drill-in</button>
	  <button id="b75" type="button" class="btn btn-danger">EntIT Drill-in</button>
	  
	  
	</div>

	<div style="width:550px" class="input-group input-group-sm">
	
      <input id="input_kanbanstart" type="text" class="form-control input-sm">
      <span class="input-group-btn">
        <button id="b50" class="btn btn-default input-sm" type="button">kanban start</button>
      </span>
      
     <input id="input_kanbanend" type="text" class="form-control input-sm">
      <span class="input-group-btn">
        <button id="b51" class="btn btn-default input-sm" type="button">kanban end</button>
      </span>

	<input id="input_timemachine" type="text" class="form-control input-sm">
      <span class="input-group-btn">
        <button id="b40" class="btn btn-default input-sm" type="button">time machine</button>
      </span>
	
      
    </div><!-- /input-group -->



     
	<div style="width:300px" class="input-group input-group-sm">
      <input id="input_width" type="text" class="form-control input-sm">
      <span class="input-group-btn">
        <button id="b11" class="btn btn-default input-sm" type="button">set WIDTH</button>
      </span>
      
      <input id="input_height" type="text" class="form-control input-sm">
      <span class="input-group-btn">
        <button id="b12" class="btn btn-default input-sm" type="button">set HEIGHT</button>
      </span>
      
    </div><!-- /input-group -->


	<div class="btn-group-xs">
	  <button id="b1" type="button" class="btn btn-default">Queues</button>
	  <button id="b2" type="button" class="btn btn-default">Items</button>
	  <button id="b3" type="button" class="btn btn-default">Lanes</button>
	  <button id="b4" type="button" class="btn btn-default">Grid</button>
	  <button id="b5" type="button" class="btn btn-default">Metrics</button>
	  <button id="b8" type="button" class="btn btn-default">Releases</button>
	  <button id="b0" type="button" class="btn btn-default">Dependencies</button>
	  <button id="b9" type="button" class="btn btn-default">Swag</button>
	  <button id="b15" type="button" class="btn btn-default">Linechart</button>
	  <button id="b6" type="button" class="btn btn-default">WIP=120</button>
	  <button id="b7" type="button" class="btn btn-default">WIP=90</button>
	  <button id="b10" type="button" class="btn btn-default">Blur Back</button>
	  
	  

	</div>

	<div style="width:250px" class="input-group input-group-sm">
      <input id="input_postit" type="text" class="form-control input-sm">
      <span class="input-group-btn">
        <button id="b30" class="btn btn-default input-sm" type="button">create postit</button>
      </span>
   </div><!-- /input-group -->




	<!-- ########### The Export Section ####### -->
	<div>
			<button class="btn btn-primary btn-xs" id="save_as_svg" value="">
				Save as SVG</button>
			<button class="btn btn-primary btn-xs" id="save_as_pdf" value="">
				Save as PDF</button>
			<button class="btn btn-primary btn-xs" id="save_as_png" value="">
				Save as PNG</button>
			&nbsp;<button class="btn btn-warning btn-xs" id="show_svg_code" value="">
				Show SVG</button>

			<div style="width:400px" class="input-group input-group-sm">
				  <input id="input_transcode_url" type="text" class="form-control input-sm">
				  <span class="input-group-btn">
					<button id="b99" class="btn btn-default input-sm" type="button">set transcode URL</button>
				  </span>
			</div><!-- /input-group -->

			
	</div>
	
	<div class="btn-group-xs">
	  <button id="l1" type="button" class="btn btn-info">Backlog Treemap</button>
	  <button id="l2" type="button" class="btn btn-info">Backlog Tree</button>
	  <button id="l3" type="button" class="btn btn-info">Backlog ForceMap</button>
	</div>

	  <div class="control-zoom">
			  <a class="control-zoom-in" href="#" title="Zoom in"></a>
			  <a class="control-zoom-out" href="#" title="Zoom out"></a>
	  </div>
		


<script>
	// Attached actions to the buttons
	
	$("#show_svg_code").click(function() { show_svg_code(); });
	$("#save_as_svg").click(function() { submit_download_form("svg"); });
	$("#save_as_pdf").click(function() { submit_download_form("pdf"); });
	$("#save_as_png").click(function() { submit_download_form("png"); });
	document.getElementById("input_transcode_url").value = TRANSCODE_URL;
	$("#b99").click(function() { TRANSCODE_URL = document.getElementById("input_transcode_url").value });
		
	initHandlers();
		
function initHandlers(){	
	
	d3.select("#b0").on("click", function(){
		var dep = d3.select("#dependencies").selectAll("g");
		if (dep.style("visibility") =="visible") dep.style("visibility","hidden");
		else dep.style("visibility","visible");
	});

	d3.select("#b1").on("click", function(){
		if (d3.select("#queues").style("visibility") =="visible") d3.select("#queues").style("visibility","hidden");
		else d3.select("#queues").style("visibility","visible");
	});

	d3.select("#b2").on("click", function(){
		if (d3.select("#items").style("visibility") =="visible") d3.selectAll("#items,#postits").style("visibility","hidden");
		else d3.selectAll("#items,#postits").style("visibility","visible");
	});

	d3.select("#b3").on("click", function(){
		if (d3.select("#lanes").style("visibility") =="visible") d3.select("#lanes").style("visibility","hidden");
		else d3.select("#lanes").style("visibility","visible");
	});

	d3.select("#b4").on("click", function(){
		if (d3.select("#axes").style("visibility") =="visible") d3.select("#axes").style("visibility","hidden");
		else d3.select("#axes").style("visibility","visible");
	});

	d3.select("#b5").on("click", function(){
		if (d3.select("#metrics").style("visibility") =="visible") d3.select("#metrics").style("visibility","hidden");
		else d3.select("#metrics").style("visibility","visible");
	});	


	d3.select("#b15").on("click", function(){
		if (d3.select("#linechart").style("visibility") =="visible"){
			 d3.select("#linechart").style("visibility","hidden");
			 d3.select("#items").selectAll("g").filter(function(d){return (d.lane=="bwin") && new Date(d.planDate)<=TODAY ;}).attr("filter", 0);

		}
		else{
			d3.select("#linechart").style("visibility","visible");
			d3.select("#items").selectAll("g").filter(function(d){return (d.lane=="bwin") && new Date(d.planDate)<=TODAY ;}).attr("filter", "url(#blur)");

		}
	});	


	d3.select("#b8").on("click", function(){
		if (d3.select("#releases").style("visibility") =="visible"){
			 d3.select("#releases").style("visibility","hidden");
			 d3.select("#items").style("opacity",1);
		 }
		 
		else{
			 d3.select("#releases").style("visibility","visible");
			 d3.select("#items").style("opacity",0.5);
		 }
	});	

	d3.select("#b9").on("click", function(){
		if (d3.select("#sizings").style("opacity") >0){
		 
			 d3.selectAll("#items,#queues,#postits,#metrics")
			 .style("visibility","visible");
			 
			 d3.selectAll("#sizings,#labels")
			 .transition()
			 .delay(0)
			 .duration(1000)
			 .style("opacity",0);

			 d3.selectAll("#items,#queues,#lanes,#axes,#postits,#metrics")
			 .transition()
			 .delay(0)
			 .duration(1000)
			 .style("opacity",1);
			 
		/*	 d3.selectAll("#items,#queues,#lanes,#axes")
			 .attr("filter", 0);
		*/	 
		 }
		 
		else{
			 
			 d3.selectAll("#sizings,#labels")
			 .transition()
			 .delay(0)
			 .duration(1000)
			 .style("opacity",1);

			 d3.selectAll("#items,#queues,#postits,#metrics")
			 .transition()
			 .delay(0)
			 .duration(1000)
			 .style("opacity",0);
			 
			 d3.selectAll("#items,#queues,#postits,#metrics")
			 .transition()
			 .delay(1000)
			 .style("visibility","hidden");
			 
			 d3.selectAll("#lanes,#axes")
			 .transition()
			 .duration(1000)
			 .style("opacity",0.5);
			 
	/*		 d3.selectAll("#items,#queues,#lanes,#axes")
			 .attr("filter", "url(#blur)")
			 .transitioned;
	*/
		 }
	});	

	d3.select("#b6").on("click", function(){
		WIP_WINDOW_DAYS = 120;
		setWIP();
		drawAll();
	});	

	d3.select("#b7").on("click", function(){
		WIP_WINDOW_DAYS = 90;
		setWIP();
		drawAll();
	});	

	d3.select("#b10").on("click", function(){
	// do blur
	if (!d3.selectAll("#metrics,#queues,#lanes").attr("filter")) d3.selectAll("#metrics,#queues,#lanes").attr("filter", "url(#blur)");
	else d3.selectAll("#metrics,#queues,#lanes").attr("filter", "");

	});


	document.getElementById("input_width").value = WIDTH;
	d3.select("#b11").on("click", function(){
		WIDTH = document.getElementById("input_width").value;
		drawAll();
	});	

	document.getElementById("input_height").value = HEIGHT;
	d3.select("#b12").on("click", function(){
		HEIGHT = document.getElementById("input_height").value;
		drawAll();
	});	


	d3.select("#b30").on("click", function(){
		post = new Postit(null,document.getElementById("input_postit").value,x(KANBAN_START),-50,2,4,"blue","red");
		var gCustomPostits = d3.select("#kanban").append("g").attr("id","customPostits");
		
		post.draw(gCustomPostits);
		post.save();

	});	

	document.getElementById("input_timemachine").value = TODAY.toString('yyyy-MM-dd');  ;
	d3.select("#b40").on("click", function(){
		timeMachine(document.getElementById("input_timemachine").value);
	});	


	document.getElementById("input_kanbanstart").value = KANBAN_START.toString('yyyy-MM-dd');  ;
	d3.select("#b50").on("click", function(){
		KANBAN_START=new Date(document.getElementById("input_kanbanstart").value);
		drawAll();
	});	

	document.getElementById("input_kanbanend").value = KANBAN_END.toString('yyyy-MM-dd');  ;
	d3.select("#b51").on("click", function(){
		KANBAN_END=new Date(document.getElementById("input_kanbanend").value);
		drawAll();
	});	


	d3.select("#b70").on("click", function(){
		renderHolding();
	});	

	d3.select("#b71").on("click", function(){
		renderB2CGaming();
	});	

	d3.select("#b72").on("click", function(){
		renderNewBiz();
	});	

	d3.select("#b73").on("click", function(){
		renderBwin();
	});	

	d3.select("#b74").on("click", function(){
		renderBwinSecondLevel();
	});	

	d3.select("#b75").on("click", function(){
		renderEntIT();
	});	



	d3.select("#b77").on("click", function(){
		renderTechdebt();
	});	

	d3.select("#b78").on("click", function(){
		renderShared();
	});	



	d3.select("#l1").on("click", function(){
		window.location.href="treemap.html";
	});	

	d3.select("#l2").on("click", function(){
		window.location.href="tree.html";
	});	

	d3.select("#l3").on("click", function(){
		window.location.href="force.html";
	});	
}
		

</script>




	

</body>
</html>
